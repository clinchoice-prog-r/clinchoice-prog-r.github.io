---
title: "R package"
author: "Tao Xiang"
date: '2022-11-23'
output:
  slidy_presentation:
    duration: 45
    footer: Copyright (c) 2022, Clinchoice
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Outline

- Install R packages
- Structure and documentation of R package
- Create a package step by step

## Install R packages

- CRAN 
  - (Currently, the CRAN package repository features 18875 available packages - Nov2022)
```{r, eval=FALSE, echo=TRUE}
install.packages("tidyverse")
```
- Bioconductor Packages 
  - (Open source and open development, most for computational biology and bioinformatics, 2183 packages - NOV2022)
```{r, eval=FALSE, echo=TRUE}
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install(version = "3.16")
```
- Local zipped file .gz.tar
```{r, eval=FALSE, echo=TRUE}
install.packages("tidyverse_1.3.1.tar", repos = NULL, type = "source")
```
- GitHub
```{r, eval=FALSE, echo=TRUE}
library(devtools)
install_github("cran/pwr")
install_github("https://github.com/cran/pwr")
```

## Why we need packages?

- Save time
- Organizing code in a package makes programming easier because packages come with conventions

## Basic structure of an R Package

![](png/survival.png)

- Brief introduction or survival package structure
  - DESCRIPTION: metadata, basic information, dependency…
  - NAMESPACE: control the imported and exported objects.
  - R: R code
  - man: manual
  - src: other language (c, java…)
  - test: test validity of your functions
  - vignettes: an overall description of your package

## Investigate classical survival package

- library a package

```{r, eval=FALSE, echo=TRUE}
library(survival)
```

- help file about the package

```{r, eval=FALSE, echo=TRUE}
help(package = 'survival')
```

- help file about one function

```{r, eval=FALSE, echo=TRUE}
?coxph
```

- check out vignettes

```{r, eval=FALSE, echo=TRUE}
browseVignettes("survival")
```

## Structure of R package

- R/: the most important directory is R/
- DESCRIPTION: basic information, dependency.
- Documentation: Learning how to use this package
- Vignettes: function documentation describes details of every function in your package.They’re long-form documents that show how to combine multiple parts of your package to solve real problems.
- Tests: to ensure your package works as designed (and continues to work as you make changes), it’s essential to write unit tests which define correct behavior, and alert you when functions break.
- Namespace: To define what functions it makes available to other packages and what functions it requires from other packages.
- data/: this directory allows you to include data with your package.
- src/: other programming languages.

## Package metadata: DESCRIPTION

- The job of the DESCRIPTION file is to store important metadata about your package. Every package must have a DESCRIPTION. In fact, it’s the defining feature of a package.

  - LazyLoad, if yes delays the loading of functions until they are required
  - Title and description
  - Author
  - Dependencies
  - License
  - Version
  
## The minimal DESCRIPTION Sample

```{r, eval=FALSE, echo=TRUE}
Package: mypackage
Title: What the Package Does (One Line, Title Case)
Version: 0.0.0.9000
Authors@R: 
    person("First", "Last", , "first.last@example.com", role = c("aut", "cre"),
           comment = c(ORCID = "YOUR-ORCID-ID"))
Description: What the package does (one paragraph).
License: `use_mit_license()`, `use_gpl3_license()` or friends to pick a
    license
Encoding: UTF-8
Roxygen: list(markdown = TRUE)
RoxygenNote: 7.2.2
```

## Package metadata: The NAMESPACE file

- The NAMESPACE file looks like R code. Each line contains a directive. Each directive describes an R object, and says whether it’s exported from this package to be used by others, or it’s imported from another package to be used locally.

- The following code is an excerpt of the NAMESPACE file from the testthat package

```{r, eval=FALSE, echo=TRUE}
# Generated by roxygen2 (4.0.2): do not edit by hand
S3method(as.character,expectation)
S3method(compare,character)
export(auto_test)
export(auto_test_package)
export(colourise)
export(context)
exportClasses(ListReporter)
exportClasses(MinimalReporter)
importFrom(methods,setRefClass)
useDynLib(testthat,duplicate_)
useDynLib(testthat,reassign_function)
```

- We don't need to revise the namespace file by hand, these will be managed by devtools.

## Dependencies: What does your package need?

- Packages listed in **Imports** are needed by your users at runtime

```{r, eval=FALSE, echo=TRUE}
# Package needs both dplyr and tidyr to work with minimal version
Imports:
    dplyr (>= 1.0.0),
    tidyr (>= 1.1.0)
```

- Packages listed in Suggests are either needed for development tasks or might unlock optional functionality for your users

```{r, eval=FALSE, echo=TRUE}
# Package can take advantage of ggplot2 and testthat, they’re not absolutely required
Suggests:
    ggplot2,
    testthat
```

## Licensing

- License your code to make clear how you want people to treat it

  - [GPLv3 license](https://choosealicense.com/licenses/gpl-3.0/): A copyleft license so that all derivatives and bundles of your code are also open source

  - [CC0 license](https://choosealicense.com/licenses/cc0-1.0/): If your package primarily contains data, not code, and you want minimal restrictions
  
  - [MIT license](https://choosealicense.com/licenses/mit/): A permissive license so people can use your code with minimal restrictions

  - [Apache](https://choosealicense.com/licenses/apache-2.0/): Contains patent license and retaliation clause to prevent patents from encumbering the software project

  - More others could be found on [https://choosealicense.com/licenses/](https://choosealicense.com/licenses/)
  
## Version number

- The suggested version number of your in-development package will have four components, `major.minor.patch.dev`, where dev is at least 9000. For example, the first version of the package should be 0.0.0.9000

- Released packages don’t have a dev component, for example: 0.8.1

- Up-version suggestion:

  - Increment patch, e.g. 0.8.2 for a patch: you’ve fixed bugs without adding any significant new features.
  
  - Increment minor, e.g. 0.9.0, for a minor release. A minor release can include bug fixes, new features and changes in backward compatibility.
  
  - Increment major, e.g. 1.0.0, for a major release.
  
- Generally and formally, at least two integers separated by either . or - in sequence is a valid version number.

## Manual folder (/man)

- Standardized-documented objects .Rd files in the man/ directory within package

- Plain text, based on LaTex, and could be rendered to HTML or PDF for reviewing

- Essential and crucial to be part of the package

## Zero to One, Step by Step (with Devtool)

- Here we initiate a new package for example step by step

  - 1. Load the devtools package
  - 2. Call create_package()
  - 3. Write you R function in code
  - 4. Write R fucntion and documentation file
  - 5. document()
  - 6. use_data() prepare package data
  - 7. use_testthat() to prepare test functions
  - 8. test() to preform test
  - 9. use_vignette() generate vignettes
  - 10. check() check the package
  - 11. call use_mit_license() to license your package
  - 12. build() build the package
  - 13. install() install the package
  - 14. R CMD check

## 1. Load the devtools package

```{r, eval=FALSE, echo=TRUE}
library(devtools)

# Check version and upgrade when necessary
packageVersion("devtools")
```

## 2. Call create_package()

- Call create_package() to initialize a new package in a directory

```{r, eval=FALSE, echo=TRUE}
## set working directory
setwd("~/Documents")

## Use argument open = FALSE to prevent R open a new R studio session
usethis::create_package("Test", open = FALSE) 
pkgwd<-'~/Documents/Test'
setwd(pkgwd)
```

## 3. Write you R function in code

- ctab.R

```{r, eval=FALSE, echo=TRUE}
##' @export
ctab <- function(n11, n12, n21, n22) rbind(c(n11, n12), c(n21, n22))
```

- cspval.R

```{r, eval=FALSE, echo=TRUE}
##' @export
cspval <- function(n11, n12, n21, n22) {
  a<- ctab(n11, n12, n21, n22)
  chisq.test(a, correct = T)$p.value
}
```

## 4a. use_r()

- Creates and/or opens a script below R/

```{r, eval=FALSE, echo=TRUE}
use_r("ctab")

use_r("cspval")
```


## 4b. Write R documentation file

```{r, eval=FALSE, echo=TRUE}
#' Create a 2x2 contingency table
#'
#' @param n11 numeric values in col 1, row 1
#' @param n12 numeric values in col 1, row 2
#' @param n21 numeric values in col 2, row 1
#' @param n22 numeric values in col 2, row 2
#'
#' @return A numeric matrix.
#' @export
#'
#' @examples
#' ctab(13, 6, 3, 15)
ctab <- function(n11, n12, n21, n22) rbind(c(n11, n12), c(n21, n22))
```

```{r, eval=FALSE, echo=TRUE}

#' Chi-square p-value for a 2x2 contingency table
#'
#' @param n11 numeric values in col 1, row 1
#' @param n12 numeric values in col 1, row 2
#' @param n21 numeric values in col 2, row 1
#' @param n22 numeric values in col 2, row 2
#'
#' @return A numeric p-value for Chi-square test
#' @export
#'
#' @examples
#' cspval(13, 6, 3, 15)
cspval <- function(n11, n12, n21, n22) {
  a<- ctab(n11, n12, n21, n22)
  chisq.test(a, correct = T)$p.value
}
```

## 4c. load_all()

- Test drive your function

```{r, eval=FALSE, echo=TRUE}
load_all()
```

- Similar to use source()

## 5. Convert roxygen comment and generate R documentation file with devtools::document()

```{r, eval=FALSE, echo=TRUE}
document()
#> i Updating Test documentation
#>i Loading Test
#>Writing NAMESPACE
#>Writing cspval.Rd
#>Writing ctab.Rd
```

## 6a. use_data() prepare external data

```{r, eval=FALSE, echo=TRUE}
sampledata <- sample(1000)
usethis::use_data(sampledata)
```

- Will create data folder

## 6b. documenting external data

- Sample document from roxygen2 block

```{r, eval=FALSE, echo=TRUE}
#' World Health Organization TB data
#'
#' A subset of data from the World Health Organization Global Tuberculosis
#' Report ...
#'
#' @format ## `who`
#' A data frame with 7,240 rows and 60 columns:
#' \describe{
#'   \item{country}{Country name}
#'   \item{iso2, iso3}{2 & 3 letter ISO country codes}
#'   \item{year}{Year}
#'   ...
#' }
#' @source <https://www.who.int/teams/global-tuberculosis-programme/data>
"who"
```

- format gives an overview of the dataset

- source provides details of where you got the data, often a URL

## 6c. internal data

- These objects are only available within the package namespace

- Will be saved as sysdata.rda in R/

- No documentation

```{r, eval=FALSE, echo=TRUE}
sampledata <- sample(1000)
usethis::use_data(sampledata, internal = TRUE)
```

## 7. use_testthat() to prepare test functions

```{r, eval=FALSE, echo=TRUE}
use_testthat()
# v Adding 'testthat' to Suggests field in DESCRIPTION
# v Setting Config/testthat/edition field in DESCRIPTION to '3'
# v Creating 'tests/testthat/'
# v Writing 'tests/testthat.R'
```

```{r, eval=FALSE, echo=TRUE}
use_test("cspval")

test_that("cspval() calculate chisq p-value", {
  expect_equal(cspval(5,5,5,5), 1)
})
```

## 8. test() to preform test

- Perform a test

```{r, eval=FALSE, echo=TRUE}
test()
```

## 9. use_vignette() generate vignettes

```{r, eval=FALSE, echo=TRUE}
browseVignettes()
```

- Make Vignettes

```{r, eval=FALSE, echo=TRUE}
use_vignette("test")
```

## 10. check() check the package

- check the package and address issues

```{r, eval=FALSE, echo=TRUE}
check()
```

## 11. call use_mit_license() to license your package

```{r, eval=FALSE, echo=TRUE}
use_mit_license()
#> ✔ Setting License field in DESCRIPTION to 'MIT + file LICENSE'
#> ✔ Writing 'LICENSE'
#> ✔ Writing 'LICENSE.md'
#> ✔ Adding '^LICENSE\\.md$' to '.Rbuildignore'
```

## 12. build() build the package

- Generate .tar.gz package by calling build()

- Package will be created in current working directory

```{r, eval=FALSE, echo=TRUE}
build() 
## default argument is pkg = ".", current working directory
```


## 13. install() install the package

- install the package

```{r, eval=FALSE, echo=TRUE}
install() ## default argument is pkg = ".", current working directory
install(build_vignettes = TRUE) ## also build the vignettes
```

- remove the package

```{r, eval=FALSE, echo=TRUE}
remove.packages("Test")
```

- Install from local source

```{r, eval=FALSE, echo=TRUE}
install.packages(file.path("~/document","Test_0.0.0.9000.tar.gz"),repos=NULL,type="source")
```

## 14. R CMD check

- Gold standard for checking that an R package is in full working order.

```{r, eval=FALSE, echo=TRUE}
system("R CMD check ~/document/GatorPKG_0.0.0.9000.tar.gz")
```

## 15. Post hoc

- Package dependencies

- use_github()

- Host R packages in GitHub and commit

- More work for maintenance

## Details and reference

[R Packages (2e)](https://r-pkgs.org/)









